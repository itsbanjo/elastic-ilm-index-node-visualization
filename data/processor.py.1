import logging
from utils.helpers import calculate_disk_usage, calculate_memory_usage, determine_node_type

logger = logging.getLogger(__name__)

class DataProcessor:
    def __init__(self, raw_data):
        self.raw_data = raw_data
        self.cluster_data = {"name": "Cluster", "children": []}
        self.rolling_indices = {}
        self.max_indices_per_node = 1000  # Limit the number of indices shown per node
        self.min_index_size_to_show = 1  # Minimum size in MB to show an index individually

    def process_data(self):
        logger.debug(f"Processing data. Raw data keys: {self.raw_data.keys()}")
        self._process_nodes()
        self._process_indices()
        return {
            "cluster_data": self.cluster_data,
            "rolling_indices": self.rolling_indices
        }

    def _process_nodes(self):
        node_types = {"hot": [], "warm": [], "cold": [], "frozen": []}
        nodes_stats = self.raw_data['nodes_stats.json'].get('nodes', {})
        nodes_info = self.raw_data['nodes_info.json'].get('nodes', {})
        
        logger.debug(f"Processing nodes. Stats keys: {nodes_stats.keys()}, Info keys: {nodes_info.keys()}")

        for node_id, node_info in nodes_info.items():
            node_stats = nodes_stats.get(node_id, {})
            node_type = determine_node_type(node_info)
            node_data = {
                "name": node_info.get('name', 'Unknown'),
                "diskUsage": calculate_disk_usage(node_stats),
                "diskTotal": node_stats.get('os', {}).get('fs', {}).get('total', 0),
                "memoryUsage": calculate_memory_usage(node_stats),
                "memoryTotal": node_stats.get('os', {}).get('mem', {}).get('total', 0),
                "cpuUsage": node_stats.get('os', {}).get('cpu', {}).get('percent', 0),
                "children": self._get_node_indices(node_id)
            }
            node_types[node_type].append(node_data)

        for node_type, nodes in node_types.items():
            if nodes:
                self.cluster_data["children"].append({
                    "name": f"{node_type.capitalize()} Nodes",
                    "children": nodes
                })

    def _get_node_indices(self, node_id):
        node_indices = []
        other_indices = {"name": "Other Indices", "size": 0, "count": 0}
        indices_stats = self.raw_data['indices_stats.json'].get('indices', {})
        
        for index_name, index_stats in indices_stats.items():
            shards = index_stats.get('shards', {})
            for shard_id, shard_data in shards.items():
                if isinstance(shard_data, list):
                    shard = next((s for s in shard_data if s.get('routing', {}).get('node') == node_id), None)
                elif isinstance(shard_data, dict):
                    shard = shard_data if shard_data.get('routing', {}).get('node') == node_id else None
                else:
                    continue

                if shard:
                    size = shard.get('store', {}).get('size_in_bytes', 0) / (1024 * 1024)  # Convert to MB
                    if size >= self.min_index_size_to_show and len(node_indices) < self.max_indices_per_node:
                        index_data = {
                            "name": index_name,
                            "size": round(size, 2),
                            "rollingIndex": self._determine_rolling_index(index_name)
                        }
                        node_indices.append(index_data)
                    else:
                        other_indices["size"] += size
                        other_indices["count"] += 1
                    break  # We only need one shard to represent the index on this node

        if other_indices["count"] > 0:
            other_indices["size"] = round(other_indices["size"], 2)
            node_indices.append(other_indices)

        return node_indices

    def _determine_rolling_index(self, index_name):
        parts = index_name.split('-')
        if len(parts) > 1 and parts[-1].isdigit():
            rolling_index = '-'.join(parts[:-1])
            if rolling_index not in self.rolling_indices:
                self.rolling_indices[rolling_index] = []
            self.rolling_indices[rolling_index].append(index_name)
            return rolling_index
        return None

    def _process_indices(self):
        # This method can be used to process global index information if needed
        pass
